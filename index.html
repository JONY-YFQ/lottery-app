<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI 彩票核对助手 - 联调版</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&family=Share+Tech+Mono&display=swap" rel="stylesheet">
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'cyber-black': '#050505',
                        'cyber-gray': '#1a1a1a',
                        'neon-green': '#39ff14',
                        'neon-cyan': '#00f3ff',
                        'dim-text': '#4a4a4a',
                    },
                    fontFamily: {
                        'tech': ['"Share Tech Mono"', 'monospace'],
                        'title': ['"Orbitron"', 'sans-serif'],
                    },
                    boxShadow: {
                        'glow-green': '0 0 10px rgba(57, 255, 20, 0.6), 0 0 20px rgba(57, 255, 20, 0.3)',
                        'glow-cyan': '0 0 10px rgba(0, 243, 255, 0.6), 0 0 20px rgba(0, 243, 255, 0.3)',
                    },
                    animation: {
                        'scan': 'scan 2s linear infinite',
                    },
                    keyframes: {
                        scan: {
                            '0%': { top: '0%', opacity: 0 },
                            '10%': { opacity: 1 },
                            '90%': { opacity: 1 },
                            '100%': { top: '100%', opacity: 0 },
                        }
                    }
                }
            }
        }
    </script>
    <style>
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        .glass-panel {
            background: rgba(26, 26, 26, 0.6);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
    </style>
</head>
<body class="text-gray-200 font-tech flex justify-center min-h-screen bg-black">

    <div class="w-full max-w-md h-screen relative flex flex-col overflow-hidden border-x border-gray-800 shadow-2xl">
        
        <header class="p-4 flex justify-between items-center bg-cyber-black/80 backdrop-blur-md z-20 border-b border-gray-800">
            <div class="flex items-center gap-2">
                <div class="w-2 h-2 rounded-full bg-neon-green animate-pulse"></div>
                <h1 class="font-title text-neon-cyan tracking-wider text-sm">QUANTUM LOTTERY</h1>
            </div>
            <div class="text-xs text-dim-text">ONLINE</div>
        </header>

        <main id="uploadPage" class="flex-1 flex flex-col items-center justify-center p-6 space-y-8 transition-opacity duration-500">
            <div class="relative w-64 h-80 border-2 border-neon-cyan/30 rounded-lg p-2 flex items-center justify-center bg-cyber-gray/20">
                <div id="scanLine" class="hidden absolute w-full h-1 bg-neon-green shadow-glow-green animate-scan opacity-50"></div>
                
                <div class="absolute top-0 left-0 w-4 h-4 border-t-2 border-l-2 border-neon-cyan"></div>
                <div class="absolute top-0 right-0 w-4 h-4 border-t-2 border-r-2 border-neon-cyan"></div>
                <div class="absolute bottom-0 left-0 w-4 h-4 border-b-2 border-l-2 border-neon-cyan"></div>
                <div class="absolute bottom-0 right-0 w-4 h-4 border-b-2 border-r-2 border-neon-cyan"></div>
                
                <div id="uploadPrompt" class="text-center space-y-2">
                    <svg class="w-12 h-12 text-gray-500 mx-auto" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M15 13a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>
                    <p class="text-sm text-gray-400">点击拍照 / 上传</p>
                </div>

                <div id="loadingPrompt" class="hidden flex flex-col items-center gap-4">
                    <div class="w-12 h-12 border-4 border-neon-cyan border-t-transparent rounded-full animate-spin"></div>
                    <div class="text-neon-cyan text-sm tracking-widest animate-pulse">正在连接神经网络...</div>
                </div>
                
                <input type="file" id="fileInput" class="absolute inset-0 opacity-0 cursor-pointer" accept="image/*" onchange="uploadImage()">
            </div>
            <p class="text-xs text-dim-text max-w-xs text-center">Server Status: http://localhost:8000</p>
        </main>

        <main id="resultPage" class="hidden flex-1 flex flex-col p-0 overflow-hidden">
            <div class="bg-gradient-to-b from-gray-900 to-black p-6 pb-8 border-b border-gray-800 relative">
                <div class="absolute top-0 right-0 w-32 h-32 bg-neon-green/10 rounded-full blur-3xl pointer-events-none"></div>
                
                <div class="text-center space-y-1 mb-4">
                    <h2 class="text-2xl font-title text-white pt-2" id="resultTitle">分析完成</h2>
                    <p class="text-xs text-gray-400" id="issueText">第 ---- 期</p>
                </div>

                <div class="flex flex-col items-center justify-center my-2">
                    <div class="text-sm text-gray-500 mb-1">中奖总金额</div>
                    <div class="text-5xl font-bold text-neon-green drop-shadow-lg tracking-tighter" id="totalMoney">
                        ¥ 0
                    </div>
                </div>
            </div>

            <div id="ticketList" class="flex-1 overflow-y-auto no-scrollbar p-4 space-y-4">
                </div>

            <div class="p-4 bg-cyber-black border-t border-gray-800 z-20 pb-8">
                <button onclick="location.reload()" class="w-full py-4 bg-gray-800 hover:bg-gray-700 text-white font-bold rounded-lg transition-all border border-gray-600 tracking-widest text-sm">
                    扫描下一张
                </button>
            </div>
        </main>
    </div>

    <script>
        async function uploadImage() {
            const input = document.getElementById('fileInput');
            if (input.files.length === 0) return;

            // 1. 切换UI状态到“加载中”
            document.getElementById('uploadPrompt').classList.add('hidden');
            document.getElementById('loadingPrompt').classList.remove('hidden');
            document.getElementById('loadingPrompt').classList.add('flex');
            document.getElementById('scanLine').classList.remove('hidden');

            const formData = new FormData();
            formData.append('file', input.files[0]);

            try {
                // 2. 发送请求给 Python 后端
                console.log("正在发送请求到 /upload ...");
                const response = await fetch('http://localhost:8000/upload', {
                    method: 'POST',
                    body: formData
                });

                const data = await response.json();
                console.log("后端返回数据:", data);

                if (data.error) {
                    alert("识别出错: " + data.error);
                    location.reload();
                    return;
                }

                // 3. 渲染结果
                renderResults(data);

            } catch (error) {
                console.error("请求失败:", error);
                alert("无法连接服务器，请确认 python server.py 正在运行！");
                location.reload();
            }
        }

        function renderResults(data) {
            // 更新顶部信息
            document.getElementById('issueText').innerText = `第 ${data.issue} 期 | 自动核对`;
            document.getElementById('totalMoney').innerText = `¥ ${data.total_money}`;
            
            if (data.total_money > 0) {
                document.getElementById('resultTitle').innerText = "恭喜中奖!";
                document.getElementById('resultTitle').classList.add('text-neon-green');
            } else {
                document.getElementById('resultTitle').innerText = "未中奖";
                document.getElementById('resultTitle').classList.remove('text-neon-green');
            }

            const listContainer = document.getElementById('ticketList');
            listContainer.innerHTML = ''; // 清空列表

            // 遍历每一注号码
            data.tickets.forEach(ticket => {
                // 样式逻辑：中奖则高亮，不中则灰暗
                const isHit = ticket.is_hit; // 从后端获取中奖标记
                
                // 容器样式
                const cardClass = isHit 
                    ? "glass-panel rounded-xl p-4 relative overflow-hidden border border-neon-green/50 shadow-glow-green"
                    : "glass-panel rounded-xl p-4 relative opacity-60 grayscale";
                
                // 奖金标签
                const badgeHtml = isHit 
                    ? `<span class="text-xs bg-neon-green text-black font-bold px-2 py-1 rounded shadow-glow-green">${ticket.prize} ¥${ticket.money}</span>`
                    : `<span class="text-xs text-gray-500">未中奖</span>`;
                
                // 红球样式 (中奖则变成绿色背景)
                const redBallClass = isHit
                    ? "w-8 h-8 rounded-full bg-neon-green text-black font-bold flex items-center justify-center shadow-glow-green text-sm"
                    : "w-8 h-8 rounded-full bg-gray-800 text-dim-text flex items-center justify-center text-sm border border-gray-700";

                // 生成红球 HTML
                let redBallsHtml = ticket.red.map(num => 
                    `<div class="${redBallClass}">${num}</div>`
                ).join('');

                // 蓝球样式
                const blueBallClass = "w-8 h-8 rounded-full bg-gray-900 text-blue-500 font-bold flex items-center justify-center text-sm border border-blue-900/30 ml-2";

                // 组合卡片 HTML
                const html = `
                    <div class="${cardClass}">
                        <div class="flex justify-between items-start mb-3">
                            <span class="text-xs ${isHit ? 'text-neon-green font-bold' : 'text-gray-400'}">
                                ${ticket.id}. 双色球
                            </span>
                            ${badgeHtml}
                        </div>
                        <div class="flex justify-between gap-1">
                            ${redBallsHtml}
                            <div class="${blueBallClass}">${ticket.blue}</div>
                        </div>
                    </div>
                `;
                
                listContainer.insertAdjacentHTML('beforeend', html);
            });

            // 切换页面
            document.getElementById('uploadPage').classList.add('hidden');
            document.getElementById('resultPage').classList.remove('hidden');
            document.getElementById('resultPage').classList.add('flex');
        }
    </script>
</body>
</html>